const x="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",S="8/8/8/8/8/8/8/8";class d{constructor(e=void 0){this.squares=new Array(64).fill(null),this.setFen(e)}setFen(e=S){let t;e==="start"?t=x:e==="empty"||e===void 0?t=S:t=e;const s=t.replace(/^\s*/,"").replace(/\s*$/,"").split(/\/|\s/);for(let i=0;i<8;i++){const r=s[7-i].replace(/\d/g,o=>{const a=parseInt(o);let c="";for(let u=0;u<a;u++)c+="-";return c});for(let o=0;o<8;o++){const a=r.substring(o,o+1);let c=null;a!=="-"&&(a.toUpperCase()===a?c=`w${a.toLowerCase()}`:c=`b${a}`),this.squares[i*8+o]=c}}}getFen(){let e=new Array(8).fill("");for(let t=0;t<8;t++){let s=0;for(let i=0;i<8;i++){const r=this.squares[t*8+i];if(!r)s++;else{s>0&&(e[7-t]+=s,s=0);const o=r.substring(0,1),a=r.substring(1,2);o==="w"?e[7-t]+=a.toUpperCase():e[7-t]+=a}}s>0&&(e[7-t]+=s,s=0)}return e.join("/")}getPieces(e=["k","q","r","b","n","p"]){const t=[],s=(i,r)=>e.indexOf(i.name)-e.indexOf(r.name);for(let i=0;i<64;i++){const r=this.squares[i];r&&t.push({name:r.charAt(1),color:r.charAt(0),position:d.indexToSquare(i)})}return e&&t.sort(s),t}movePiece(e,t){if(!this.squares[d.squareToIndex(e)]){console.warn("no piece on",e);return}this.squares[d.squareToIndex(t)]=this.squares[d.squareToIndex(e)],this.squares[d.squareToIndex(e)]=void 0}setPiece(e,t){this.squares[d.squareToIndex(e)]=t}getPiece(e){return this.squares[d.squareToIndex(e)]}static squareToIndex(e){const t=e.substring(0,1).charCodeAt(0)-97;return 8*(e.substring(1,2)-1)+t}static indexToSquare(e){const t=String.fromCharCode(e%8+97),s=Math.floor(e/8)+1;return t+s}clone(){const e=new d;return e.squares=this.squares.slice(0),e}}class T{constructor(){this.position=new d,this.orientation=void 0,this.markers=[],this.inputWhiteEnabled=!1,this.inputBlackEnabled=!1,this.inputEnabled=!1,this.squareSelectEnabled=!1,this.extensionPoints={}}setPosition(e,t=!1){this.position=new d(e,t)}movePiece(e,t,s=!1){const i=this._position.clone();i.animated=s;const r=i.getPiece(e);r||console.error("no piece on",e),i.setPiece(e,void 0),i.setPiece(t,r),this._position=i}setPiece(e,t,s=!1){const i=this._position.clone();i.animated=s,i.setPiece(e,t),this._position=i}addMarker(e,t){this.markers.push({square:e,type:t})}removeMarkers(e=void 0,t=void 0){!e&&!t?this.markers=[]:this.markers=this.markers.filter(s=>{if(t){if(e){if(s.type===t&&e===s.square)return!1}else if(s.type===t)return!1}else if(e===s.square)return!1;return!0})}invokeExtensionPoints(e,t={}){const s=this.extensionPoints[e],i=Object.assign({},t);if(i.extensionPoint=e,s)for(const r of s)setTimeout(()=>{r(i)})}}const n={waitForInputStart:0,pieceClickedThreshold:1,clickTo:2,secondClickThreshold:3,dragTo:4,clickDragTo:5,moveDone:6,reset:7},g={secondClick:"secondClick",movedOutOfBoard:"movedOutOfBoard",draggedBack:"draggedBack",clickedAnotherPiece:"clickedAnotherPiece"},k=4;class C{constructor(e,t,s,i){this.view=e,this.chessboard=e.chessboard,this.moveStartCallback=r=>t(r),this.moveDoneCallback=(r,o)=>s(r,o),this.moveCanceledCallback=(r,o,a)=>{i(r,o,a)},this.setMoveInputState(n.waitForInputStart)}setMoveInputState(e,t=void 0){const s=this.moveInputState;switch(this.moveInputState=e,e){case n.waitForInputStart:break;case n.pieceClickedThreshold:if(n.waitForInputStart!==s&&n.clickTo!==s)throw new Error("moveInputState");if(this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=void 0),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=void 0),this.fromSquare=t.square,this.toSquare=void 0,this.movedPiece=t.piece,this.updateStartEndMarkers(),this.startPoint=t.point,!this.pointerMoveListener&&!this.pointerUpListener)if(t.type==="mousedown")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="mousemove",addEventListener("mousemove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="mouseup",addEventListener("mouseup",this.pointerUpListener);else if(t.type==="touchstart")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="touchmove",addEventListener("touchmove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="touchend",addEventListener("touchend",this.pointerUpListener);else throw Error("event type");else throw Error("_pointerMoveListener or _pointerUpListener");break;case n.clickTo:this.draggablePiece&&(h.removeElement(this.draggablePiece),this.draggablePiece=void 0),s===n.dragTo&&this.view.setPieceVisibility(t.square,!0);break;case n.secondClickThreshold:if(n.clickTo!==s)throw new Error("moveInputState");this.startPoint=t.point;break;case n.dragTo:if(n.pieceClickedThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled&&(this.view.setPieceVisibility(t.square,!1),this.createDraggablePiece(t.piece));break;case n.clickDragTo:if(n.secondClickThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled&&(this.view.setPieceVisibility(t.square,!1),this.createDraggablePiece(t.piece));break;case n.moveDone:if([n.dragTo,n.clickTo,n.clickDragTo].indexOf(s)===-1)throw new Error("moveInputState");this.toSquare=t.square,this.toSquare&&this.moveDoneCallback(this.fromSquare,this.toSquare)?s===n.clickTo?this.chessboard.movePiece(this.fromSquare,this.toSquare,!0).then(()=>{this.setMoveInputState(n.reset)}):this.chessboard.movePiece(this.fromSquare,this.toSquare,!1).then(()=>{this.view.setPieceVisibility(this.toSquare,!0),this.setMoveInputState(n.reset)}):(this.view.setPieceVisibility(this.fromSquare,!0),this.setMoveInputState(n.reset));break;case n.reset:this.fromSquare&&!this.toSquare&&this.movedPiece&&this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.fromSquare=void 0,this.toSquare=void 0,this.movedPiece=void 0,this.updateStartEndMarkers(),this.draggablePiece&&(h.removeElement(this.draggablePiece),this.draggablePiece=void 0),this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=void 0),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=void 0),this.setMoveInputState(n.waitForInputStart);break;default:throw Error(`moveInputState ${e}`)}}createDraggablePiece(e){if(this.draggablePiece)throw Error("draggablePiece exists");this.draggablePiece=h.createSvg(document.body),this.draggablePiece.classList.add("cm-chessboard-draggable-piece"),this.draggablePiece.setAttribute("width",this.view.squareWidth),this.draggablePiece.setAttribute("height",this.view.squareHeight),this.draggablePiece.setAttribute("style","pointer-events: none"),this.draggablePiece.name=e;const t=this.chessboard.props.sprite.cache?"":this.chessboard.props.sprite.url,s=h.addElement(this.draggablePiece,"use",{href:`${t}#${e}`}),i=this.view.squareHeight/this.chessboard.props.sprite.size,r=this.draggablePiece.createSVGTransform();r.setScale(i,i),s.transform.baseVal.appendItem(r)}moveDraggablePiece(e,t){this.draggablePiece.setAttribute("style",`pointer-events: none; position: absolute; left: ${e-this.view.squareHeight/2}px; top: ${t-this.view.squareHeight/2}px`)}onPointerDown(e){if(e.type==="mousedown"&&e.button===0||e.type==="touchstart"){const t=e.target.getAttribute("data-square");if(t){const s=this.chessboard.getPiece(t);let i;if(s&&(i=s?s.substring(0,1):void 0,(i==="w"&&this.chessboard.state.inputWhiteEnabled||i==="b"&&this.chessboard.state.inputBlackEnabled)&&e.preventDefault()),this.moveInputState!==n.waitForInputStart||this.chessboard.state.inputWhiteEnabled&&i==="w"||this.chessboard.state.inputBlackEnabled&&i==="b"){let r;if(e.type==="mousedown"?r={x:e.clientX,y:e.clientY}:e.type==="touchstart"&&(r={x:e.touches[0].clientX,y:e.touches[0].clientY}),this.moveInputState===n.waitForInputStart&&s&&this.moveStartCallback(t))this.setMoveInputState(n.pieceClickedThreshold,{square:t,piece:s,point:r,type:e.type});else if(this.moveInputState===n.clickTo)if(t===this.fromSquare)this.setMoveInputState(n.secondClickThreshold,{square:t,piece:s,point:r,type:e.type});else{const o=this.chessboard.getPiece(t),a=o?o.substring(0,1):void 0,c=this.chessboard.getPiece(this.fromSquare),u=c?c.substring(0,1):void 0;i&&u===a?(this.moveCanceledCallback(g.clickedAnotherPiece,this.fromSquare,t),this.moveStartCallback(t)?this.setMoveInputState(n.pieceClickedThreshold,{square:t,piece:o,point:r,type:e.type}):this.setMoveInputState(n.reset)):this.setMoveInputState(n.moveDone,{square:t})}}}}}onPointerMove(e){let t,s,i,r,o;if(e.type==="mousemove"?(i=e.clientX,r=e.clientY,t=e.pageX,s=e.pageY,o=e.target):e.type==="touchmove"&&(i=e.touches[0].clientX,r=e.touches[0].clientY,t=e.touches[0].pageX,s=e.touches[0].pageY,o=document.elementFromPoint(i,r)),this.moveInputState===n.pieceClickedThreshold||this.moveInputState===n.secondClickThreshold)(Math.abs(this.startPoint.x-i)>k||Math.abs(this.startPoint.y-r)>k)&&(this.moveInputState===n.secondClickThreshold?this.setMoveInputState(n.clickDragTo,{square:this.fromSquare,piece:this.movedPiece}):this.setMoveInputState(n.dragTo,{square:this.fromSquare,piece:this.movedPiece}),this.view.chessboard.state.inputEnabled&&this.moveDraggablePiece(t,s));else if(this.moveInputState===n.dragTo||this.moveInputState===n.clickDragTo||this.moveInputState===n.clickTo){if(o&&o.getAttribute&&o.parentElement===this.view.boardGroup){const a=o.getAttribute("data-square");a!==this.fromSquare&&a!==this.toSquare?(this.toSquare=a,this.updateStartEndMarkers()):a===this.fromSquare&&this.toSquare!==void 0&&(this.toSquare=void 0,this.updateStartEndMarkers())}else this.toSquare!==void 0&&(this.toSquare=void 0,this.updateStartEndMarkers());this.view.chessboard.state.inputEnabled&&(this.moveInputState===n.dragTo||this.moveInputState===n.clickDragTo)&&this.moveDraggablePiece(t,s)}}onPointerUp(e){let t;if(e.type==="mouseup"?t=e.target:e.type==="touchend"&&(t=document.elementFromPoint(e.changedTouches[0].clientX,e.changedTouches[0].clientY)),t&&t.getAttribute){const s=t.getAttribute("data-square");if(s)this.moveInputState===n.dragTo||this.moveInputState===n.clickDragTo?this.fromSquare===s?this.moveInputState===n.clickDragTo?(this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.view.setPieceVisibility(this.fromSquare),this.moveCanceledCallback(g.draggedBack,s,s),this.setMoveInputState(n.reset)):this.setMoveInputState(n.clickTo,{square:s}):this.setMoveInputState(n.moveDone,{square:s}):this.moveInputState===n.pieceClickedThreshold?this.setMoveInputState(n.clickTo,{square:s}):this.moveInputState===n.secondClickThreshold&&(this.setMoveInputState(n.reset),this.moveCanceledCallback(g.secondClick,s,s));else{this.view.redrawPieces();const i=this.fromSquare;this.setMoveInputState(n.reset),this.moveCanceledCallback(g.movedOutOfBoard,i,void 0)}}else this.view.redrawPieces(),this.setMoveInputState(n.reset)}updateStartEndMarkers(){this.chessboard.props.style.moveFromMarker&&this.chessboard.state.removeMarkers(void 0,this.chessboard.props.style.moveFromMarker),this.chessboard.props.style.moveToMarker&&this.chessboard.state.removeMarkers(void 0,this.chessboard.props.style.moveToMarker),this.chessboard.props.style.moveFromMarker&&this.fromSquare&&this.chessboard.state.addMarker(this.fromSquare,this.chessboard.props.style.moveFromMarker),this.chessboard.props.style.moveToMarker&&this.toSquare&&this.chessboard.state.addMarker(this.toSquare,this.chessboard.props.style.moveToMarker),this.view.drawMarkers()}reset(){this.setMoveInputState(n.reset)}destroy(){this.reset()}}const l={positionChanged:"positionChanged",boardChanged:"boardChanged",moveInputToggled:"moveInputToggled",moveInput:"moveInput",destroy:"destroy",redrawBoard:"redrawBoard"};class I{constructor(e){this.chessboard=e,this.moveInput=new C(this,this.moveStartCallback.bind(this),this.moveDoneCallback.bind(this),this.moveCanceledCallback.bind(this)),e.props.sprite.cache&&this.cacheSpriteToDiv("chessboardSpriteCache",this.chessboard.props.sprite.url),this.context=document.createElement("div"),this.chessboard.context.appendChild(this.context),e.props.responsive&&(typeof ResizeObserver<"u"?(this.resizeObserver=new ResizeObserver(()=>{this.handleResize()}),this.resizeObserver.observe(this.chessboard.context)):(this.resizeListener=this.handleResize.bind(this),window.addEventListener("resize",this.resizeListener))),this.pointerDownListener=this.pointerDownHandler.bind(this),this.pointerDownListener=this.pointerDownHandler.bind(this),this.context.addEventListener("mousedown",this.pointerDownListener),this.context.addEventListener("touchstart",this.pointerDownListener),this.createSvgAndGroups(),this.updateMetrics(),this.handleResize(),this.redrawBoard()}pointerDownHandler(e){this.moveInput.onPointerDown(e)}destroy(){this.moveInput.destroy(),this.resizeObserver&&this.resizeObserver.unobserve(this.chessboard.context),this.resizeListener&&window.removeEventListener("resize",this.resizeListener),this.chessboard.context.removeEventListener("mousedown",this.pointerDownListener),this.chessboard.context.removeEventListener("touchstart",this.pointerDownListener),this.animationQueue=[],this.currentAnimation&&cancelAnimationFrame(this.currentAnimation.frameHandle),h.removeElement(this.svg)}cacheSpriteToDiv(e,t){if(!document.getElementById(e)){const s=document.createElement("div");s.style.display="none",s.id=e,document.body.appendChild(s);const i=new XMLHttpRequest;i.open("GET",t,!0),i.onload=function(){s.insertAdjacentHTML("afterbegin",i.response)},i.send()}}createSvgAndGroups(){this.svg=h.createSvg(this.context);let e=this.chessboard.props.style.cssClass?this.chessboard.props.style.cssClass:"default";this.svg.setAttribute("class","cm-chessboard border-type-"+this.chessboard.props.style.borderType+" "+e),this.svg.setAttribute("role","img"),this.updateMetrics(),this.boardGroup=h.addElement(this.svg,"g",{class:"board"}),this.coordinatesGroup=h.addElement(this.svg,"g",{class:"coordinates"}),this.markersLayer=h.addElement(this.svg,"g",{class:"markers-layer"}),this.markersGroup=h.addElement(this.markersLayer,"g",{class:"markers"}),this.piecesLayer=h.addElement(this.svg,"g",{class:"pieces-layer"}),this.piecesGroup=h.addElement(this.piecesLayer,"g",{class:"pieces"})}updateMetrics(){this.width=this.context.clientWidth,this.height=this.context.clientWidth*(this.chessboard.props.style.aspectRatio||1),this.chessboard.props.style.borderType===m.frame?this.borderSize=this.width/25:this.chessboard.props.style.borderType===m.thin?this.borderSize=this.width/320:this.borderSize=0,this.innerWidth=this.width-2*this.borderSize,this.innerHeight=this.height-2*this.borderSize,this.squareWidth=this.innerWidth/8,this.squareHeight=this.innerHeight/8,this.scalingX=this.squareWidth/this.chessboard.props.sprite.size,this.scalingY=this.squareHeight/this.chessboard.props.sprite.size,this.pieceXTranslate=this.squareWidth/2-this.chessboard.props.sprite.size*this.scalingY/2}handleResize(){this.context.style.width=this.chessboard.context.clientWidth+"px",this.context.style.height=this.chessboard.context.clientWidth*this.chessboard.props.style.aspectRatio+"px",(this.context.clientWidth!==this.width||this.context.clientHeight!==this.height)&&(this.updateMetrics(),this.redrawBoard(),this.redrawPieces()),this.svg.setAttribute("width","100%"),this.svg.setAttribute("height","100%")}redrawBoard(){this.redrawSquares(),this.drawCoordinates(),this.drawMarkers(),this.chessboard.state.invokeExtensionPoints(l.redrawBoard),this.visualizeInputState()}redrawSquares(){for(;this.boardGroup.firstChild;)this.boardGroup.removeChild(this.boardGroup.lastChild);if(h.addElement(this.boardGroup,"rect",{width:this.width,height:this.height}).setAttribute("class","border"),this.chessboard.props.style.borderType===m.frame){const t=this.borderSize;h.addElement(this.boardGroup,"rect",{x:t,y:t,width:this.width-t*2,height:this.height-t*2}).setAttribute("class","border-inner")}for(let t=0;t<64;t++){const s=this.chessboard.state.orientation===b.white?t:63-t,r=`square ${9*s&8?"white":"black"}`,o=this.squareToPoint(d.indexToSquare(s)),a=h.addElement(this.boardGroup,"rect",{x:o.x,y:o.y,width:this.squareWidth,height:this.squareHeight});a.setAttribute("class",r),a.setAttribute("data-square",d.indexToSquare(s))}}drawCoordinates(){if(!this.chessboard.props.style.showCoordinates)return;for(;this.coordinatesGroup.firstChild;)this.coordinatesGroup.removeChild(this.coordinatesGroup.lastChild);const e=this.chessboard.props.style.borderType!==m.frame;for(let t=0;t<8;t++){let s=this.borderSize+(17+this.chessboard.props.sprite.size*t)*this.scalingX,i=this.height-this.scalingY*3.5,r="coordinate file";e&&(s=s+this.scalingX*15.5,r+=t%2?" white":" black");const o=h.addElement(this.coordinatesGroup,"text",{class:r,x:s,y:i,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===b.white?o.textContent=String.fromCharCode(97+t):o.textContent=String.fromCharCode(104-t)}for(let t=0;t<8;t++){let s=this.borderSize/3.7,i=this.borderSize+25*this.scalingY+t*this.squareHeight,r="coordinate rank";e&&(r+=t%2?" black":" white",this.chessboard.props.style.borderType===m.frame?(s=s+this.scalingX*10,i=i-this.scalingY*15):(s=s+this.scalingX*2,i=i-this.scalingY*15));const o=h.addElement(this.coordinatesGroup,"text",{class:r,x:s,y:i,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===b.white?o.textContent=""+(8-t):o.textContent=""+(1+t)}}redrawPieces(e=this.chessboard.state.position.squares){const t=Array.from(this.piecesGroup.childNodes);for(let s=0;s<64;s++){const i=e[s];i&&this.drawPiece(d.indexToSquare(s),i)}for(const s of t)this.piecesGroup.removeChild(s)}drawPiece(e,t){const s=h.addElement(this.piecesGroup,"g");s.setAttribute("data-piece",t),s.setAttribute("data-square",e);const i=this.squareToPoint(e),r=this.svg.createSVGTransform();r.setTranslate(i.x,i.y),s.transform.baseVal.appendItem(r);const o=this.chessboard.props.sprite.cache?"":this.chessboard.props.sprite.url,a=h.addElement(s,"use",{href:`${o}#${t}`,class:"piece"}),c=this.svg.createSVGTransform();c.setTranslate(this.pieceXTranslate,0),a.transform.baseVal.appendItem(c);const u=this.svg.createSVGTransform();return u.setScale(this.scalingY,this.scalingY),a.transform.baseVal.appendItem(u),s}setPieceVisibility(e,t=!0){const s=this.getPieceElement(e);s?t?s.setAttribute("visibility","visible"):s.setAttribute("visibility","hidden"):console.warn("no piece on",e)}getPieceElement(e){if(e.length<2)throw new Error("980e03");const t=this.piecesGroup.querySelector(`g[data-square='${e}']`);return t||console.warn("no piece on",e),t}drawMarkers(){for(;this.markersGroup.firstChild;)this.markersGroup.removeChild(this.markersGroup.firstChild);this.chessboard.state.markers.forEach(e=>{this.drawMarker(e)})}drawMarker(e){const t=h.addElement(this.markersGroup,"g");t.setAttribute("data-square",e.square);const s=this.squareToPoint(e.square),i=this.svg.createSVGTransform();i.setTranslate(s.x,s.y),t.transform.baseVal.appendItem(i);const r=this.chessboard.props.sprite.cache?"":this.chessboard.props.sprite.url,o=h.addElement(t,"use",{href:`${r}#${e.type.slice}`,class:"marker "+e.type.class}),a=this.svg.createSVGTransform();return a.setScale(this.scalingX,this.scalingY),o.transform.baseVal.appendItem(a),t}enableMoveInput(e,t=void 0){t===b.white?this.chessboard.state.inputWhiteEnabled=!0:t===b.black?this.chessboard.state.inputBlackEnabled=!0:(this.chessboard.state.inputWhiteEnabled=!0,this.chessboard.state.inputBlackEnabled=!0),this.chessboard.state.inputEnabled=!0,this.moveInputCallback=e,this.chessboard.state.invokeExtensionPoints(l.moveInputToggled,{enabled:!0,color:t}),this.visualizeInputState()}disableMoveInput(){this.chessboard.state.inputWhiteEnabled=!1,this.chessboard.state.inputBlackEnabled=!1,this.chessboard.state.inputEnabled=!1,this.moveInputCallback=void 0,this.chessboard.state.invokeExtensionPoints(l.moveInputToggled,{enabled:!1}),this.visualizeInputState()}moveStartCallback(e){const t={chessboard:this.chessboard,type:w.moveStart,square:e};return this.chessboard.state.invokeExtensionPoints(l.moveInput,t),this.moveInputCallback?this.moveInputCallback(t):!0}moveDoneCallback(e,t){const s={chessboard:this.chessboard,type:w.moveDone,squareFrom:e,squareTo:t};return this.chessboard.state.invokeExtensionPoints(l.moveInput,s),this.moveInputCallback?this.moveInputCallback(s):!0}moveCanceledCallback(e,t,s){const i={chessboard:this.chessboard,type:w.moveCanceled,reason:e,squareFrom:t,squareTo:s};this.chessboard.state.invokeExtensionPoints(l.moveInput,i),this.moveInputCallback&&this.moveInputCallback(i)}visualizeInputState(){this.chessboard.state&&(this.chessboard.state.inputWhiteEnabled||this.chessboard.state.inputBlackEnabled||this.chessboard.state.squareSelectEnabled?this.boardGroup.setAttribute("class","board input-enabled"):this.boardGroup.setAttribute("class","board"))}indexToPoint(e){let t,s;return this.chessboard.state.orientation===b.white?(t=this.borderSize+e%8*this.squareWidth,s=this.borderSize+(7-Math.floor(e/8))*this.squareHeight):(t=this.borderSize+(7-e%8)*this.squareWidth,s=this.borderSize+Math.floor(e/8)*this.squareHeight),{x:t,y:s}}squareToPoint(e){const t=d.squareToIndex(e);return this.indexToPoint(t)}}const P="http://www.w3.org/2000/svg";class h{static createSvg(e=void 0){let t=document.createElementNS(P,"svg");return e&&(t.setAttribute("width","100%"),t.setAttribute("height","100%"),e.appendChild(t)),t}static addElement(e,t,s,i=void 0){let r=document.createElementNS(P,t);t==="use"&&(s["xlink:href"]=s.href);for(let o in s)if(s.hasOwnProperty(o))if(o.indexOf(":")!==-1){const a=o.split(":");r.setAttributeNS("http://www.w3.org/1999/"+a[0],a[1],s[o])}else r.setAttribute(o,s[o]);return i!==void 0?e.appendChild(r):e.insertBefore(r,i),r}static removeElement(e){e.parentNode?e.parentNode.removeChild(e):console.warn(e,"without parentNode")}}class M{constructor(){this.queue=[],this.workingOnPromise=!1,this.stop=!1}async enqueue(e){return new Promise((t,s)=>{this.queue.push({promise:e,resolve:t,reject:s}),this.dequeue()})}dequeue(){if(this.workingOnPromise)return;if(this.stop){this.queue=[],this.stop=!1;return}const e=this.queue.shift();if(e){try{this.workingOnPromise=!0,e.promise().then(t=>{this.workingOnPromise=!1,e.resolve(t),this.dequeue()}).catch(t=>{this.workingOnPromise=!1,e.reject(t),this.dequeue()})}catch(t){this.workingOnPromise=!1,e.reject(t),this.dequeue()}return!0}}destroy(){this.stop=!0}}const p={move:0,appear:1,disappear:2};class v{constructor(e,t,s,i,r){this.view=e,t&&s?(this.animatedElements=this.createAnimation(t.squares,s.squares),this.duration=i,this.callback=r,this.frameHandle=requestAnimationFrame(this.animationStep.bind(this))):console.error("fromPosition",t,"toPosition",s)}static seekChanges(e,t){const s=[],i=[],r=[];for(let o=0;o<64;o++){const a=e[o],c=t[o];c!==a&&(c&&s.push({piece:c,index:o}),a&&i.push({piece:a,index:o}))}return s.forEach(o=>{let a=8,c;i.forEach(u=>{if(o.piece===u.piece){const q=v.squareDistance(o.index,u.index);q<a&&(c=u,a=q)}}),c?(i.splice(i.indexOf(c),1),r.push({type:p.move,piece:o.piece,atIndex:c.index,toIndex:o.index})):r.push({type:p.appear,piece:o.piece,atIndex:o.index})}),i.forEach(o=>{r.push({type:p.disappear,piece:o.piece,atIndex:o.index})}),r}createAnimation(e,t){const s=v.seekChanges(e,t),i=[];return s.forEach(r=>{const o={type:r.type};switch(r.type){case p.move:o.element=this.view.getPieceElement(d.indexToSquare(r.atIndex)),o.element.parentNode.appendChild(o.element),o.atPoint=this.view.indexToPoint(r.atIndex),o.toPoint=this.view.indexToPoint(r.toIndex);break;case p.appear:o.element=this.view.drawPiece(d.indexToSquare(r.atIndex),r.piece),o.element.style.opacity=0;break;case p.disappear:o.element=this.view.getPieceElement(d.indexToSquare(r.atIndex));break}i.push(o)}),i}animationStep(e){this.startTime||(this.startTime=e);const t=e-this.startTime;if(t<=this.duration)this.frameHandle=requestAnimationFrame(this.animationStep.bind(this));else{cancelAnimationFrame(this.frameHandle),this.animatedElements.forEach(r=>{r.type===p.disappear&&h.removeElement(r.element)}),this.callback();return}const s=Math.min(1,t/this.duration);let i=s<.5?2*s*s:-1+(4-2*s)*s;isNaN(i)&&(i=1),this.animatedElements.forEach(r=>{if(r.element)switch(r.type){case p.move:r.element.transform.baseVal.removeItem(0);const o=this.view.svg.createSVGTransform();o.setTranslate(r.atPoint.x+(r.toPoint.x-r.atPoint.x)*i,r.atPoint.y+(r.toPoint.y-r.atPoint.y)*i),r.element.transform.baseVal.appendItem(o);break;case p.appear:r.element.style.opacity=Math.round(i*100)/100;break;case p.disappear:r.element.style.opacity=Math.round((1-i)*100)/100;break}else console.warn("animatedItem has no element",r)})}static squareDistance(e,t){const s=e%8,i=Math.floor(e/8),r=t%8,o=Math.floor(t/8);return Math.max(Math.abs(o-i),Math.abs(r-s))}}class L extends M{constructor(e){super(),this.chessboard=e}async enqueuePositionChange(e,t,s){return e.getFen()===t.getFen()?Promise.resolve():super.enqueue(()=>new Promise(i=>{let r=s?this.chessboard.props.animationDuration:0;this.queue.length>0&&(r=r/(1+Math.pow(this.queue.length/5,2))),new v(this.chessboard.view,e,t,s?r:0,()=>{this.chessboard.view&&this.chessboard.view.redrawPieces(t.squares),i()})}))}async enqueueTurnBoard(e,t,s){return super.enqueue(()=>new Promise(i=>{const r=new d(S);let o=s?this.chessboard.props.animationDuration:0;this.queue.length>0&&(o=o/(1+Math.pow(this.queue.length/5,2))),new v(this.chessboard.view,e,r,s?o:0,()=>{this.chessboard.state.orientation=t,this.chessboard.view.redrawBoard(),this.chessboard.view.redrawPieces(r.squares),new v(this.chessboard.view,r,e,s?o:0,()=>{this.chessboard.view.redrawPieces(e.squares),i()})})}))}}const b={white:"w",black:"b"},w={moveStart:"moveStart",moveDone:"moveDone",moveCanceled:"moveCanceled"},y={primary:"primary",secondary:"secondary"},m={none:"none",thin:"thin",frame:"frame"},E={frame:{class:"marker-frame",slice:"markerFrame"}};class A{constructor(e,t={}){if(!e)throw new Error("container element is "+e);this.context=e,this.id=(Math.random()+1).toString(36).substring(2,8),this.extensions=[];let s={position:"empty",orientation:b.white,responsive:!0,animationDuration:300,language:navigator.language.substring(0,2).toLowerCase(),style:{cssClass:"default",showCoordinates:!0,borderType:m.none,aspectRatio:1,moveFromMarker:E.frame,moveToMarker:E.frame},sprite:{url:"./assets/images/chessboard-sprite.svg",size:40,cache:!0},extensions:[]};this.props={},Object.assign(this.props,s),Object.assign(this.props,t),this.props.sprite=s.sprite,this.props.style=s.style,t.sprite&&Object.assign(this.props.sprite,t.sprite),t.style&&Object.assign(this.props.style,t.style),t.extensions&&(this.props.extensions=t.extensions),this.props.language!=="de"&&this.props.language!=="en"&&(this.props.language="en"),this.state=new T,this.view=new I(this),this.positionAnimationsQueue=new L(this),this.state.orientation=this.props.orientation;for(const i of this.props.extensions)this.extensions.push(new i.class(this,i.props));this.view.redrawBoard(),this.state.position=new d(this.props.position),this.view.redrawPieces(),this.state.invokeExtensionPoints(l.positionChanged)}async setPiece(e,t,s=!1){const i=this.state.position.clone();return this.state.position.setPiece(e,t),this.state.invokeExtensionPoints(l.positionChanged),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),s)}async movePiece(e,t,s=!1){const i=this.state.position.clone();return this.state.position.movePiece(e,t),this.state.invokeExtensionPoints(l.positionChanged),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),s)}async setPosition(e,t=!1){const s=this.state.position.clone();return this.state.position.setFen(e),this.state.invokeExtensionPoints(l.positionChanged),this.positionAnimationsQueue.enqueuePositionChange(s,this.state.position.clone(),t)}async setOrientation(e,t=!1){const s=this.state.position.clone();if(this.boardTurning){console.log("setOrientation is only once in queue allowed");return}return this.boardTurning=!0,this.positionAnimationsQueue.enqueueTurnBoard(s,e,t).then(()=>{this.boardTurning=!1,this.state.invokeExtensionPoints(l.boardChanged)})}getPiece(e){return this.state.position.getPiece(e)}getPosition(){return this.state.position.getFen()}getOrientation(){return this.state.orientation}addMarker(e,t){t||console.error("Error addMarker(), type is "+t),this.state.addMarker(e,t),this.view.drawMarkers()}getMarkers(e=void 0,t=void 0){const s=[];return this.state.markers.forEach(i=>{const r=i.square;(!e&&(!t||t===i.type)||!t&&e===r||t===i.type&&e===r)&&s.push({square:i.square,type:i.type})}),s}removeMarkers(e=void 0,t=void 0){this.state.removeMarkers(e,t),this.view.drawMarkers()}enableMoveInput(e,t=void 0){this.view.enableMoveInput(e,t)}disableMoveInput(){this.view.disableMoveInput()}enableSquareSelect(e){if(this.squareSelectListener){console.warn("squareSelectListener already existing");return}this.squareSelectListener=function(t){const s=t.target.getAttribute("data-square");if(t.type==="contextmenu"){t.preventDefault();return}e({chessboard:this,type:t.button===2?y.secondary:y.primary,square:s})},this.context.addEventListener("contextmenu",this.squareSelectListener),this.context.addEventListener("mouseup",this.squareSelectListener),this.context.addEventListener("touchend",this.squareSelectListener),this.state.squareSelectEnabled=!0,this.view.visualizeInputState()}disableSquareSelect(){this.context.removeEventListener("contextmenu",this.squareSelectListener),this.context.removeEventListener("mouseup",this.squareSelectListener),this.context.removeEventListener("touchend",this.squareSelectListener),this.squareSelectListener=void 0,this.state.squareSelectEnabled=!1,this.view.visualizeInputState()}destroy(){this.state.invokeExtensionPoints(l.destroy),this.positionAnimationsQueue.destroy(),this.view.destroy(),this.view=void 0,this.state=void 0,this.squareSelectListener&&(this.context.removeEventListener("contextmenu",this.squareSelectListener),this.context.removeEventListener("mouseup",this.squareSelectListener),this.context.removeEventListener("touchend",this.squareSelectListener))}}export{m as BORDER_TYPE,b as COLOR,A as Chessboard,w as INPUT_EVENT_TYPE,E as MARKER_TYPE,y as SQUARE_SELECT_TYPE};
