rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    match /users/{userId} {
      // 1. Leer: Solo el dueño de la cuenta
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // 2. Crear: Solo el dueño, y debe inicializarse como 'free'
      allow create: if request.auth != null 
                    && request.auth.uid == userId
                    && request.resource.data.uid == userId
                    // Seguridad crucial: Al crear, el tier DEBE ser 'free' o no venir (default)
                    && (
                      !('subscriptionTier' in request.resource.data) || 
                      request.resource.data.subscriptionTier == 'free'
                    );

      // 3. Actualizar: Solo el dueño, y NO puede tocar la suscripción ni isAdmin
      allow update: if request.auth != null 
                    && request.auth.uid == userId
                    // Seguridad crucial: NO se permite cambiar estos campos
                    && !request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['subscriptionTier', 'subscriptionStatus', 'stripeCustomerId', 'stripeSubscriptionId', 'isAdmin']);
    }
    
    // Artist Profiles
    match /artistProfiles/{profileId} {
      // Public read for all profiles
      allow read: if true;
      
      // Create/Update: Only the owner
      allow create, update: if request.auth != null 
                           && request.auth.uid == profileId
                           && request.resource.data.userId == profileId;
      
      // Delete: Only the owner
      allow delete: if request.auth != null && request.auth.uid == profileId;
    }
    
    // Albums - Public read, admin write (existing rule maintained)
    match /albums/{albumId} {
      allow read: if true;
      // Write operations should be handled by admin only (via admin SDK or cloud functions)
    }
    
    // Bloqueo por defecto para todo lo demás
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
