rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // ============================================
    // Users Collection
    // ============================================
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // Albums Collection (Public Read)
    // ============================================
    match /albums/{albumId} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }
    
    // ============================================
    // Artists Collection
    // ============================================
    match /artists/{artistId} {
      allow read: if true; // Public read for verified artists
      allow create: if isSignedIn();
      allow update: if isOwner(artistId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // Proposals Collection
    // ============================================
    match /proposals/{proposalId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() 
                    && request.resource.data.authorUid == request.auth.uid
                    && request.resource.data.status == 'pending'
                    && request.resource.data.votes == 1
                    && request.resource.data.votersUp == [request.auth.uid]
                    && request.resource.data.votersDown == [];
      allow update: if isAdmin(); // Voting is handled via increment in code
      allow delete: if isAdmin();
    }
    
    // ============================================
    // Bug Reports Collection (NEW)
    // ============================================
    match /bug_reports/{bugId} {
      // Public read - anyone can see bug reports
      allow read: if true;
      
      // Anyone can create bug reports (even anonymous users)
      allow create: if request.resource.data.keys().hasAll(['title', 'description', 'severity', 'browser', 'os', 'status', 'createdAt'])
                    && request.resource.data.title is string
                    && request.resource.data.title.size() >= 5
                    && request.resource.data.title.size() <= 100
                    && request.resource.data.description is string
                    && request.resource.data.description.size() >= 10
                    && request.resource.data.description.size() <= 500
                    && request.resource.data.severity in ['low', 'medium', 'high', 'critical']
                    && request.resource.data.status == 'reported'
                    && request.resource.data.createdAt == request.time;
      
      // Only admins can update (change status, add notes)
      allow update: if isAdmin();
      
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    // ============================================
    // Music Submissions
    // ============================================
    match /musicSubmissions/{submissionId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // Listen Rooms (Shared Listening)
    // ============================================
    match /listenRooms/{roomId} {
      allow read: if true; // Public rooms can be read by anyone
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isAdmin() || (isSignedIn() && resource.data.hostId == request.auth.uid);
    }
    
    // ============================================
    // Favorites Collection
    // ============================================
    match /favorites/{favoriteId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }
  }
}
