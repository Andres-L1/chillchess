rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // USERS COLLECTION - Secure
    // ============================================
    match /users/{userId} {
      // 1. Leer: Solo el dueño de la cuenta
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // 2. Crear: Solo el dueño, y debe inicializarse como 'free'
      allow create: if request.auth != null 
                    && request.auth.uid == userId
                    && request.resource.data.uid == userId
                    // Seguridad crucial: Al crear, el tier DEBE ser 'free' o no venir (default)
                    && (
                      !('subscriptionTier' in request.resource.data) || 
                      request.resource.data.subscriptionTier == 'free'
                    );

      // 3. Actualizar: Solo el dueño, y NO puede tocar la suscripción ni isAdmin
      allow update: if request.auth != null 
                    && request.auth.uid == userId
                    // Seguridad crucial: NO se permite cambiar estos campos
                    && !request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['subscriptionTier', 'subscriptionStatus', 'stripeCustomerId', 'stripeSubscriptionId', 'isAdmin']);
    }
    
    // ============================================
    // ARTIST PROFILES - Con Validación Mejorada
    // ============================================
    match /artistProfiles/{profileId} {
      // Helper function para validar profile
      function isValidProfile() {
        let data = request.resource.data;
        let hasValidName = data.artistName is string
                          && data.artistName.size() >= 2
                          && data.artistName.size() <= 50;
        let hasValidBio = data.bio is string
                         && data.bio.size() <= 200;
        let hasValidLinks = data.socialLinks is list
                           && data.socialLinks.size() <= 10;
        let hasValidUserId = data.userId == profileId;
        
        // Validar campos opcionales solo si existen
        let validAvatar = !('avatarUrl' in data) || (data.avatarUrl is string && data.avatarUrl.size() <= 500);
        let validBanner = !('bannerUrl' in data) || (data.bannerUrl is string && data.bannerUrl.size() <= 500);
        
        // Solo permitir campos específicos
        let allowedKeys = ['userId', 'artistName', 'bio', 'avatarUrl', 'bannerUrl', 
                          'themeColor', 'accentColor', 'socialLinks', 'bannerStyle',
                          'cardLayout', 'totalPlays', 'followerCount', 'createdAt', 'updatedAt'];
        let hasOnlyAllowedKeys = data.keys().hasOnly(allowedKeys);
        
        return hasValidName && hasValidBio && hasValidLinks && hasValidUserId 
               && validAvatar && validBanner && hasOnlyAllowedKeys;
      }
      
      // Public read for all profiles
      allow read: if true;
      
      // Create/Update: Only the owner with validation
      allow create, update: if request.auth != null 
                           && request.auth.uid == profileId
                           && isValidProfile();
      
      // Delete: Only the owner
      allow delete: if request.auth != null && request.auth.uid == profileId;
    }
    
    // ============================================
    // ALBUMS - Public read, NO client writes
    // ============================================
    match /albums/{albumId} {
      allow read: if true;
      allow write: if false; // Solo Admin SDK o Cloud Functions pueden escribir
    }
    
    // ============================================
    // DEFAULT DENY - Seguridad por defecto
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
