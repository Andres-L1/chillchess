rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    function isAdmin() {
      // Check if the requesting user has isAdmin == true in their user document
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // ============================================
    // USERS COLLECTION - Secure
    // ============================================
    match /users/{userId} {
      // Leer: Dueño o Admin
      allow read: if isOwner(userId) || isAdmin();
      
      // Crear: Solo el dueño, inicializa como free
      allow create: if isOwner(userId)
                    && request.resource.data.uid == userId
                    && (
                      !('subscriptionTier' in request.resource.data) || 
                      request.resource.data.subscriptionTier == 'free'
                    );

      // Actualizar: Dueño (con restricciones) o Admin (total)
      allow update: if isAdmin() || (
                    isOwner(userId)
                    && !request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['subscriptionTier', 'subscriptionStatus', 'stripeCustomerId', 'stripeSubscriptionId', 'isAdmin'])
      );
    }
    
    // ============================================
    // ARTISTS (Perfil público) - Antes artistProfiles
    // ============================================
    match /artists/{userId} {
      // Público para leer
      allow read: if true;
      
      // Escritura: Solo el dueño
      allow write: if isOwner(userId);
    }
    
    // ============================================
    // ARTIST SUBMISSIONS & PROPOSALS
    // ============================================
    match /musicSubmissions/{submissionId} {
        allow create: if request.auth != null;
        allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
        allow update: if isAdmin(); 
    }

    match /proposals/{proposalId} {
        allow create: if request.auth != null; 
        allow read: if true; 
        allow update: if isAdmin() || 
                      (request.auth != null && resource.data.authorUid == request.auth.uid) ||
                      (request.auth != null && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['votes', 'votersUp', 'votersDown']));
    }

    // ============================================
    // ALBUMS - Public read, Admin write
    // ============================================
    match /albums/{albumId} {
      allow read: if true;
      allow write: if isAdmin(); 
    }
    
    // ============================================
    // LISTENING ROOMS - Real-time shared listening
    // ============================================
    match /listeningRooms/{roomId} {
      // Allow anyone authenticated to read public rooms
      allow read: if request.auth != null && (resource.data.isPublic == true || isAdmin());
      
      // Allow participants to read their room
      allow read: if request.auth != null && 
                     request.auth.uid in resource.data.participants;
      
      // Create
      allow create: if request.auth != null &&
                       request.resource.data.hostId == request.auth.uid;
      
      // Update: Host or Participant (self update) or Admin
      allow update: if isAdmin() || (request.auth != null && (
        resource.data.hostId == request.auth.uid ||
        (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['participants']) &&
          request.resource.data.participants[request.auth.uid] != null
        )
      ));
      
      // Delete: Host or Admin
      allow delete: if isAdmin() || (request.auth != null && resource.data.hostId == request.auth.uid);
    }
    
    // ============================================
    // WIDGET SYNC (Real-time OBS)
    // ============================================
    match /nowPlaying/{userId} {
      // Público: El widget (página web no auth) necesita leer esto
      allow read: if true;
      
      // Escritura: Solo el usuario dueño de la sesión actualiza su "now playing"
      allow write: if isOwner(userId);
    }

    // ============================================
    // CREATOR CATALOG (Music for Streamers)
    // ============================================
    match /creatorCatalog/{itemId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ============================================
    // DEFAULT DENY
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
