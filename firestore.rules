rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection - cada usuario solo puede leer/escribir su propio documento
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Solo el usuario puede escribir, pero con restricciones
      allow write: if request.auth != null 
                   && request.auth.uid == userId
                   && request.resource.data.uid == userId
                   && request.resource.data.email == request.auth.token.email;
      
      // Prevenir que usuarios modifiquen su subscriptionTier manualmente
      // (solo webhooks de Stripe pueden hacerlo via Admin SDK)
      allow update: if request.auth != null 
                    && request.auth.uid == userId
                    && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['subscriptionTier', 'subscriptionStatus', 'stripeCustomerId', 'stripeSubscriptionId']))
                    || request.auth.token.admin == true; // Solo admin/backend
    }
    
    // Bloquear todo lo dem√°s
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
